name: Update Reports (No Scraping)

on:
  push:
    branches:
      - main
    paths:
      - 'generate_report.py'
      - 'visualizer.py'
      - 'analyzer.py'
      - 'templates/**'
      - 'config/**'
  workflow_dispatch:  # Manual trigger option

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  regenerate_reports:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Reports only take ~2 minutes

    steps:
      - name: Checkout Code with LFS
        uses: actions/checkout@v4
        with:
          lfs: true  # Pull existing database from Git LFS

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Verify Database Exists
        run: |
          if [ ! -f "data/intelligence.db" ]; then
            echo "ERROR: Database not found. Run weekly scraper first."
            exit 1
          fi
          echo "Database found: $(ls -lh data/intelligence.db)"

      - name: Generate Static Report
        env:
          FORCE_REANALYZE: 'false'  # Database already updated with v1.5 taxonomy
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python generate_report.py

      - name: Generate Visual Trends
        run: |
          python visualizer.py

      - name: Commit and Push Reports
        run: |
          git config --global user.name 'Report Bot'
          git config --global user.email 'bot@noreply.github.com'

          # Check if database was modified (FORCE_REANALYZE updated classifications)
          if git diff --name-only | grep -q "data/intelligence.db"; then
            echo "âœ… Database modified by FORCE_REANALYZE - including in commit"
            git add data/intelligence.db
          fi

          # Add generated reports
          git add public/ data/*.csv || echo "No CSV files to add"

          if git diff --staged --quiet; then
            echo "No report changes to commit"
          else
            git commit -m "chore: regenerate reports from existing data [skip ci]"

            # Pull with rebase, handling any conflicts
            git pull --rebase origin main || {
              echo "Rebase conflict detected, attempting to resolve..."
              git rebase --abort
              git pull --no-rebase origin main
              git push origin main --force-with-lease
              exit 0
            }

            git push origin main
          fi

      - name: Deploy to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

  deploy:
    needs: regenerate_reports
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
